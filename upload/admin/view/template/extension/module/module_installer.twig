{{ header }}{{ column_left }}
<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <div class="pull-right">
        <button type="submit" form="form-module" data-toggle="tooltip" title="{{ button_save }}" class="btn btn-primary"><i class="fa fa-save"></i></button>
        <a href="{{ cancel }}" data-toggle="tooltip" title="{{ button_cancel }}" class="btn btn-default"><i class="fa fa-reply"></i></a></div>
      <h1>{{ heading_title }}</h1>
      <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
        <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>
  <div class="container-fluid">
    {% if error_warning %}
    <div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}
      <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
    {% endif %}
    {% if success %}
    <div class="alert alert-success alert-dismissible"><i class="fa fa-check-circle"></i> {{ success }}
      <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
    {% endif %}
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title"><i class="fa fa-pencil"></i> {{ text_edit }}</h3>
      </div>
      <div class="panel-body">
        <form action="{{ action }}" method="post" enctype="multipart/form-data" id="form-module" class="form-horizontal">
          <div class="form-group">
            <label class="col-sm-2 control-label" for="input-status">{{ entry_status }}</label>
            <div class="col-sm-10">
              <select name="module_module_installer_status" id="input-status" class="form-control">
                {% if module_module_installer_status %}
                <option value="1" selected="selected">{{ text_enabled }}</option>
                <option value="0">{{ text_disabled }}</option>
                {% else %}
                <option value="1">{{ text_enabled }}</option>
                <option value="0" selected="selected">{{ text_disabled }}</option>
                {% endif %}
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label class="col-sm-2 control-label" for="input-github-repo">
              {{ entry_github_repo }}
              <span data-toggle="tooltip" title="{{ entry_github_repo_help }}"></span>
            </label>
            <div class="col-sm-10">
              <input type="text" name="module_module_installer_github_repo" value="{{ module_module_installer_github_repo }}" id="input-github-repo" class="form-control" placeholder="owner/repo" />
              <span class="help-block">{{ entry_github_repo_help }}</span>
            </div>
          </div>
          
          <div class="form-group">
            <label class="col-sm-2 control-label" for="input-github-token">
              {{ entry_github_token }}
              <span data-toggle="tooltip" title="{{ entry_github_token_help }}"></span>
            </label>
            <div class="col-sm-10">
              {% if module_module_installer_github_token == '***HIDDEN***' %}
              <input type="password" name="module_module_installer_github_token" value="" id="input-github-token" class="form-control" autocomplete="off" placeholder="(токен уже установлен)" />
              <span class="help-block"><small class="text-muted">Токен уже установлен. Оставьте поле пустым, чтобы не изменять его, или введите новый токен для замены.</small></span>
              {% else %}
              <input type="password" name="module_module_installer_github_token" value="" id="input-github-token" class="form-control" autocomplete="off" />
              {% endif %}
              <span class="help-block">{{ entry_github_token_help }}</span>
            </div>
          </div>
          
          <div class="form-group">
            <label class="col-sm-2 control-label" for="input-github-branch">
              {{ entry_github_branch }}
              <span data-toggle="tooltip" title="{{ entry_github_branch_help }}"></span>
            </label>
            <div class="col-sm-10">
              <input type="text" name="module_module_installer_github_branch" value="{{ module_module_installer_github_branch }}" id="input-github-branch" class="form-control" placeholder="main" />
              <span class="help-block">{{ entry_github_branch_help }}</span>
            </div>
          </div>
          
          <div class="form-group">
            <label class="col-sm-2 control-label" for="input-artifact-name">
              {{ entry_artifact_name }}
              <span data-toggle="tooltip" title="{{ entry_artifact_name_help }}"></span>
            </label>
            <div class="col-sm-10">
              <input type="text" name="module_module_installer_artifact_name" value="{{ module_module_installer_artifact_name }}" id="input-artifact-name" class="form-control" placeholder="oc_telegram_shop.ocmod.zip" />
              <span class="help-block">{{ entry_artifact_name_help }}</span>
            </div>
          </div>
          
          <div class="form-group">
            <label class="col-sm-2 control-label" for="input-deploy-secret-key">
              {{ entry_deploy_secret_key }}
              <span data-toggle="tooltip" title="{{ entry_deploy_secret_key_help }}"></span>
            </label>
            <div class="col-sm-10">
              <input type="text" name="module_module_installer_deploy_secret_key" value="{{ module_module_installer_deploy_secret_key }}" id="input-deploy-secret-key" class="form-control" />
              <span class="help-block">{{ entry_deploy_secret_key_help }}</span>
            </div>
          </div>
          
          {% if module_module_installer_last_deployed_sha %}
          <div class="form-group">
            <label class="col-sm-2 control-label">{{ entry_last_deployed_sha }}</label>
            <div class="col-sm-10">
              <code>{{ module_module_installer_last_deployed_sha }}</code>
            </div>
          </div>
          {% endif %}
        </form>
      </div>
    </div>
    
    {% if module_module_installer_last_deploy_log %}
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title"><i class="fa fa-history"></i> {{ entry_last_deploy_log }}</h3>
      </div>
      <div class="panel-body">
        <div class="form-group">
          <label class="col-sm-2 control-label">Время:</label>
          <div class="col-sm-10">
            <code>{{ module_module_installer_last_deploy_log.timestamp }}</code>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label">Commit SHA:</label>
          <div class="col-sm-10">
            <code>{{ module_module_installer_last_deploy_log.sha }}</code>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label">Результат:</label>
          <div class="col-sm-10">
            {% if module_module_installer_last_deploy_log.success %}
            <span class="label label-success">Успешно</span>
            {% else %}
            <span class="label label-danger">Ошибка</span>
            {% endif %}
            {% if module_module_installer_last_deploy_log.files_count is defined %}
            <span class="label label-info" style="margin-left: 10px;">Установлено файлов: {{ module_module_installer_last_deploy_log.files_count }}</span>
            {% endif %}
          </div>
        </div>
        {% if module_module_installer_last_deploy_log.log %}
        <div class="form-group">
          <label class="col-sm-2 control-label">Полный лог:</label>
          <div class="col-sm-10">
            <pre style="max-height: 300px; overflow-y: auto; background: #f5f5f5; padding: 10px; border-radius: 4px;">{{ module_module_installer_last_deploy_log.log }}</pre>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
    
    {% if deploy_secret_key %}
    <div class="panel panel-warning">
      <div class="panel-heading">
        <h3 class="panel-title"><i class="fa fa-rocket"></i> Принудительный деплой</h3>
      </div>
      <div class="panel-body">
        <div class="alert alert-info">
          <i class="fa fa-info-circle"></i> Принудительный деплой выполнит установку модуля независимо от того, изменился ли commit SHA.
        </div>
        
        <div class="form-group">
          <label class="col-sm-2 control-label"></label>
          <div class="col-sm-10">
            <button type="button" id="btn-deploy-force" class="btn btn-warning btn-lg" onclick="triggerForceDeploy()" data-deploy-url="{{ deploy_action_url }}">
              <i class="fa fa-exclamation-circle"></i> {{ button_deploy_force }}
            </button>
            <span id="deploy-force-status" style="margin-left: 15px;"></span>
          </div>
        </div>
        
        <div class="form-group" id="deploy-logs-container" style="display: none;">
          <label class="col-sm-2 control-label">Логи деплоя:</label>
          <div class="col-sm-10">
            <div id="deploy-logs" style="max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 15px; border-radius: 4px; font-family: 'Courier New', Courier, monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word;"></div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    
    <div class="panel panel-info">
      <div class="panel-heading">
        <h3 class="panel-title"><i class="fa fa-info-circle"></i> Информация о CLI</h3>
      </div>
      <div class="panel-body">
        <div class="alert alert-info">
          {{ info_description }}
        </div>
        
        <div class="form-group">
          <label class="col-sm-2 control-label">{{ info_cli_path }}</label>
          <div class="col-sm-10">
            <code>{{ cli_path }}</code>
            {% if cli_exists %}
            <span class="label label-success">{{ info_cli_exists }}</span>
            {% else %}
            <span class="label label-danger">{{ info_cli_not_found }}</span>
            {% endif %}
          </div>
        </div>
        
        <div class="form-group">
          <label class="col-sm-2 control-label">{{ info_cli_usage }}</label>
          <div class="col-sm-10">
            <pre>{{ cli_usage }}</pre>
          </div>
        </div>
      </div>
    </div>
    
    <div class="panel panel-primary">
      <div class="panel-heading">
        <h3 class="panel-title"><i class="fa fa-github"></i> Автодеплой из GitHub</h3>
      </div>
      <div class="panel-body">
        <div class="alert alert-warning">
          <i class="fa fa-exclamation-triangle"></i> <strong>Внимание:</strong> Используйте секретный ключ для защиты эндпоинта. Не передавайте его в открытом виде.
        </div>
        
        <div class="form-group">
          <label class="col-sm-2 control-label">{{ info_deploy_url }}</label>
          <div class="col-sm-10">
            <code id="deploy-url">{{ deploy_url }}</code>
            <button type="button" class="btn btn-sm btn-default" onclick="copyToClipboard('deploy-url')">
              <i class="fa fa-copy"></i> Копировать
            </button>
          </div>
        </div>
        
        <div class="form-group">
          <label class="col-sm-2 control-label"></label>
          <div class="col-sm-10">
            <p>{{ info_deploy_description }}</p>
          </div>
        </div>
        
        <div class="form-group">
          <label class="col-sm-2 control-label">{{ info_deploy_examples }}</label>
          <div class="col-sm-10">
            {% if deploy_secret_key %}
            <p style="margin-bottom: 15px;"><strong>{{ info_deploy_example_normal }}</strong></p>
            <pre id="example-normal" class="deploy-example-code">curl -X POST "{{ deploy_url }}" \
  -d "token={{ deploy_secret_key }}"</pre>
            <button type="button" class="btn btn-sm btn-default" onclick="copyToClipboard('example-normal')" style="margin-bottom: 20px;">
              <i class="fa fa-copy"></i> {{ button_copy }}
            </button>
            
            <p style="margin-bottom: 15px;"><strong>{{ info_deploy_example_force }}</strong></p>
            <pre id="example-force" class="deploy-example-code">curl -X POST "{{ deploy_url }}" \
  -d "token={{ deploy_secret_key }}&force=1"</pre>
            <button type="button" class="btn btn-sm btn-default" onclick="copyToClipboard('example-force')" style="margin-bottom: 20px;">
              <i class="fa fa-copy"></i> {{ button_copy }}
            </button>
            
            <p style="margin-bottom: 15px;"><strong>{{ info_deploy_example_json }}</strong></p>
            <pre id="example-json" class="deploy-example-code">curl -X POST "{{ deploy_url }}" \
  -H "Content-Type: application/json" \
  -d '{"token":"{{ deploy_secret_key }}","force":1}'</pre>
            <button type="button" class="btn btn-sm btn-default" onclick="copyToClipboard('example-json')" style="margin-bottom: 20px;">
              <i class="fa fa-copy"></i> {{ button_copy }}
            </button>
            
            <p style="margin-bottom: 15px;"><strong>{{ info_deploy_example_github_actions }}</strong></p>
            <pre id="example-github-actions" class="deploy-example-code">- name: Trigger deployment
  run: |
    curl -X POST "{{ deploy_url }}" \
      -d "token=${{ "{{ secrets.DEPLOY_SECRET_KEY }}" }}"</pre>
            <button type="button" class="btn btn-sm btn-default" onclick="copyToClipboard('example-github-actions')">
              <i class="fa fa-copy"></i> {{ button_copy }}
            </button>
            {% else %}
            <p class="text-warning">{{ info_deploy_example_no_key }}</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<style>
.deploy-example-code {
  position: relative;
  padding: 10px;
  background-color: #f5f5f5;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-family: 'Courier New', Courier, monospace;
  font-size: 12px;
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-x: auto;
  max-width: 100%;
  line-height: 1.5;
}
</style>
<script>
function copyToClipboard(elementId) {
  var element = document.getElementById(elementId);
  var text = element.textContent || element.innerText;
  
  // Убираем лишние пробелы и переносы строк в начале и конце
  text = text.trim();
  
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(function() {
      alert('Скопировано в буфер обмена!');
    }).catch(function(err) {
      alert('Не удалось скопировать');
    });
  } else {
    // Fallback для старых браузеров
    var textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      alert('Скопировано в буфер обмена!');
    } catch (err) {
      alert('Не удалось скопировать');
    }
    document.body.removeChild(textArea);
  }
}

function triggerForceDeploy() {
  var btnForce = document.getElementById('btn-deploy-force');
  var statusDiv = document.getElementById('deploy-force-status');
  var logsContainer = document.getElementById('deploy-logs-container');
  var logsDiv = document.getElementById('deploy-logs');
  
  // Отключаем кнопку
  btnForce.disabled = true;
  
  // Показываем индикатор загрузки
  statusDiv.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Запуск деплоя...';
  
  // Показываем блок с логами и очищаем его
  logsContainer.style.display = 'block';
  logsDiv.innerHTML = 'Запуск деплоя...\n\n';
  
  // Формируем URL - используем админский прокси метод
  // Берем URL из data-атрибута кнопки или декодируем из шаблона
  var deployUrl = btnForce.getAttribute('data-deploy-url');
  if (!deployUrl) {
    // Fallback: декодируем HTML-сущности (&amp; -> &)
    var deployUrlRaw = '{{ deploy_action_url }}';
    deployUrl = deployUrlRaw.replace(/&amp;/g, '&');
  }
  
  // Выполняем AJAX запрос (POST с данными)
  var xhr = new XMLHttpRequest();
  xhr.open('POST', deployUrl, true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      // Включаем кнопку обратно
      btnForce.disabled = false;
      
      if (xhr.status === 200) {
        try {
          var responseText = xhr.responseText;
          
          // Пробуем распарсить как JSON
          var response;
          try {
            response = JSON.parse(responseText);
          } catch (e) {
            // Если не JSON, показываем сырой ответ
            logsDiv.innerHTML += '\n=== Ответ сервера (не JSON) ===\n' + responseText;
            statusDiv.innerHTML = '<span class="text-warning"><i class="fa fa-exclamation-triangle"></i> Получен не JSON ответ</span>';
            return;
          }
          
          // Добавляем информацию о деплое в логи
          logsDiv.innerHTML += '\n=== Информация о деплое ===\n';
          if (response.current_sha) {
            logsDiv.innerHTML += 'Текущий SHA: ' + response.current_sha + '\n';
          }
          if (response.previous_sha) {
            logsDiv.innerHTML += 'Предыдущий SHA: ' + response.previous_sha + '\n';
          }
          logsDiv.innerHTML += 'Статус: ' + (response.status || 'unknown') + '\n';
          logsDiv.innerHTML += 'Сообщение: ' + (response.message || 'нет') + '\n';
          
          // Дополнительная информация об ошибках
          if (response.http_code) {
            logsDiv.innerHTML += 'HTTP код: ' + response.http_code + '\n';
          }
          if (response.json_error) {
            logsDiv.innerHTML += 'Ошибка парсинга JSON: ' + response.json_error + '\n';
          }
          if (response.curl_error) {
            logsDiv.innerHTML += 'Ошибка CURL: ' + response.curl_error + '\n';
          }
          if (response.raw_response) {
            logsDiv.innerHTML += '\nСырой ответ сервера:\n' + response.raw_response + '\n';
          }
          
          if (response.status === 'success') {
            statusDiv.innerHTML = '<span class="text-success"><i class="fa fa-check-circle"></i> ' + (response.message || 'Деплой успешно выполнен!') + '</span>';
            logsDiv.innerHTML += '\n=== ✓ Деплой завершен успешно ===\n';
            
            // Перезагружаем страницу через 3 секунды для обновления логов
            setTimeout(function() {
              location.reload();
            }, 3000);
          } else {
            statusDiv.innerHTML = '<span class="text-danger"><i class="fa fa-exclamation-circle"></i> ' + (response.message || 'Ошибка при деплое') + '</span>';
            logsDiv.innerHTML += '\n=== ✗ Деплой завершен с ошибкой ===\n';
          }
          
          // Прокручиваем логи вниз
          logsDiv.scrollTop = logsDiv.scrollHeight;
          
        } catch (e) {
          logsDiv.innerHTML += '\n\n=== ОШИБКА ПРИ РАЗБОРЕ ОТВЕТА ===\n';
          logsDiv.innerHTML += 'Ошибка: ' + e.message + '\n';
          logsDiv.innerHTML += 'Сырой ответ:\n' + xhr.responseText.substring(0, 1000) + '\n';
          statusDiv.innerHTML = '<span class="text-danger"><i class="fa fa-exclamation-circle"></i> Ошибка при разборе ответа сервера: ' + e.message + '</span>';
          logsDiv.scrollTop = logsDiv.scrollHeight;
        }
      } else {
        statusDiv.innerHTML = '<span class="text-danger"><i class="fa fa-exclamation-circle"></i> HTTP ошибка: ' + xhr.status + '</span>';
        logsDiv.innerHTML += '\n\n=== ОШИБКА HTTP ===\n';
        logsDiv.innerHTML += 'HTTP код: ' + xhr.status + '\n';
        if (xhr.responseText) {
          logsDiv.innerHTML += 'Ответ сервера:\n' + xhr.responseText.substring(0, 500) + '\n';
        }
        logsDiv.scrollTop = logsDiv.scrollHeight;
      }
    }
  };
  xhr.onerror = function() {
    btnForce.disabled = false;
    statusDiv.innerHTML = '<span class="text-danger"><i class="fa fa-exclamation-circle"></i> Ошибка сети при выполнении запроса</span>';
    logsDiv.innerHTML += '\n\n=== ОШИБКА СЕТИ ===\n';
    logsDiv.innerHTML += 'Не удалось выполнить запрос к серверу.\n';
    logsContainer.style.display = 'block';
    logsDiv.scrollTop = logsDiv.scrollHeight;
  };
  xhr.onloadstart = function() {
    logsDiv.innerHTML += 'Отправка запроса...\n';
    logsDiv.scrollTop = logsDiv.scrollHeight;
  };
  
  // Отправляем POST данные с параметром force
  var postData = 'force=1';
  xhr.send(postData);
}
</script>
{{ footer }}

